<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>sedna.service.server.aggregation API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>sedna.service.server.aggregation</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># Copyright 2021 The KubeEdge Authors.
#
# Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import time
from typing import List, Optional, Dict

import uuid
from pydantic import BaseModel
from fastapi import FastAPI, WebSocket
from fastapi.routing import APIRoute
from starlette.requests import Request
from starlette.responses import JSONResponse
from starlette.routing import WebSocketRoute
from starlette.endpoints import WebSocketEndpoint
from starlette.types import ASGIApp, Receive, Scope, Send

from sedna.common.log import LOGGER
from sedna.common.utils import get_host_ip

from .base import BaseServer

__all__ = (&#39;AggregationServer&#39;,)


class WSClientInfo(BaseModel):  # pylint: disable=too-few-public-methods
    &#34;&#34;&#34;
    client information
    &#34;&#34;&#34;

    client_id: str
    connected_at: float
    job_count: int


class WSClientInfoList(BaseModel):  # pylint: disable=too-few-public-methods
    clients: List


class WSEventMiddleware:  # pylint: disable=too-few-public-methods
    def __init__(self, app: ASGIApp, **kwargs):
        self._app = app
        self._server = Aggregator(**kwargs)

    async def __call__(self, scope: Scope, receive: Receive, send: Send):
        if scope[&#34;type&#34;] in (&#34;lifespan&#34;, &#34;http&#34;, &#34;websocket&#34;):
            servername = scope[&#34;path&#34;].lstrip(&#34;/&#34;)
            scope[servername] = self._server
        await self._app(scope, receive, send)


class WSServerBase:
    def __init__(self):
        self._clients: Dict[str, WebSocket] = {}
        self._client_meta: Dict[str, WSClientInfo] = {}

    def __len__(self) -&gt; int:
        return len(self._clients)

    @property
    def empty(self) -&gt; bool:
        return len(self._clients) == 0

    @property
    def client_list(self) -&gt; List[str]:
        # Todo: Considering the expansion of server center,
        #  saving the data to a database would be more appropriate.

        return list(self._clients)

    def add_client(self, client_id: str, websocket: WebSocket):
        if client_id in self._clients:
            raise ValueError(f&#34;Client {client_id} is already in the server&#34;)
        LOGGER.info(f&#34;Adding client {client_id}&#34;)
        self._clients[client_id] = websocket
        self._client_meta[client_id] = WSClientInfo(
            client_id=client_id, connected_at=time.time(), job_count=0
        )

    async def kick_client(self, client_id: str):
        if client_id not in self._clients:
            raise ValueError(f&#34;Client {client_id} is not in the server&#34;)
        await self._clients[client_id].close()

    def remove_client(self, client_id: str):
        if client_id not in self._clients:
            raise ValueError(f&#34;Client {client_id} is not in the server&#34;)
        LOGGER.info(f&#34;Removing Client {client_id} from server&#34;)
        del self._clients[client_id]
        del self._client_meta[client_id]

    def get_client(self, client_id: str) -&gt; Optional[WSClientInfo]:
        return self._client_meta.get(client_id)

    async def send_message(self, client_id: str, msg: Dict):
        self._client_meta[client_id].job_count += 1
        for to_client, websocket in self._clients.items():
            if to_client == client_id:
                continue
            LOGGER.info(f&#34;send data to Client {to_client} from server&#34;)
            await websocket.send_json(msg)

    async def client_joined(self, client_id: str):
        for websocket in self._clients.values():
            await websocket.send_json({&#34;type&#34;: &#34;CLIENT_JOIN&#34;,
                                       &#34;data&#34;: client_id})

    async def client_left(self, client_id: str):
        for to_client, websocket in self._clients.items():
            if to_client == client_id:
                continue
            await websocket.send_json({&#34;type&#34;: &#34;CLIENT_LEAVE&#34;,
                                       &#34;data&#34;: client_id})


class Aggregator(WSServerBase):
    def __init__(self, **kwargs):
        super(Aggregator, self).__init__()
        self.exit_round = int(kwargs.get(&#34;exit_round&#34;, 3))
        self.current_round = {}

    async def send_message(self, client_id: str, msg: Dict):
        self._client_meta[client_id].job_count += 1
        clients = list(self._clients.items())
        for to_client, websocket in clients:

            if msg.get(&#34;type&#34;, &#34;&#34;) == &#34;update_weight&#34;:
                if to_client == client_id:
                    continue
                self.current_round[to_client] = self.current_round.get(
                    to_client, 0) + 1
                exit_flag = &#34;ok&#34; if self.exit_check(to_client) else &#34;continue&#34;
                msg[&#34;exit_flag&#34;] = exit_flag
            try:
                await websocket.send_json(msg)
            except Exception as err:
                LOGGER.error(err)

    def exit_check(self, client_id):
        current_round = self.current_round.get(client_id, 0)
        return current_round &gt;= self.exit_round


class BroadcastWs(WebSocketEndpoint):
    encoding: str = &#34;json&#34;
    session_name: str = &#34;&#34;
    count: int = 0

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.server: Optional[Aggregator] = None
        self.client_id: Optional[str] = None

    async def on_connect(self, websocket: WebSocket):
        servername = websocket.scope[&#39;path&#39;].lstrip(&#34;/&#34;)
        LOGGER.info(&#34;Connecting new client...&#34;)
        server: Optional[Aggregator] = self.scope.get(servername)
        if server is None:
            raise RuntimeError(&#34;HOST `client` instance unavailable!&#34;)
        self.server = server
        await websocket.accept()

    async def on_disconnect(self, _websocket: WebSocket, _close_code: int):
        if self.client_id is None:
            raise RuntimeError(
                &#34;on_disconnect() called without a valid client_id&#34;
            )
        self.server.remove_client(self.client_id)
        await self.server.client_left(self.client_id)

    async def on_receive(self, _websocket: WebSocket, msg: Dict):
        command = msg.get(&#34;type&#34;, &#34;&#34;)
        if command == &#34;subscribe&#34;:
            self.client_id = msg.get(&#34;client_id&#34;, &#34;&#34;) or uuid.uuid4().hex
            await self.server.client_joined(self.client_id)
            self.server.add_client(self.client_id, _websocket)
        if self.client_id is None:
            raise RuntimeError(&#34;on_receive() called without a valid client_id&#34;)
        await self.server.send_message(self.client_id, msg)


class AggregationServer(BaseServer):
    def __init__(
            self,
            servername: str,
            host: str = None,
            http_port: int = 7363,
            exit_round: int = 1,
            ws_size: int = 10 *
            1024 *
            1024):
        if not host:
            host = get_host_ip()
        super(
            AggregationServer,
            self).__init__(
            servername=servername,
            host=host,
            http_port=http_port,
            ws_size=ws_size)
        self.server_name = servername
        self.exit_round = max(int(exit_round), 1)
        self.app = FastAPI(
            routes=[
                APIRoute(
                    f&#34;/{servername}&#34;,
                    self.client_info,
                    response_class=JSONResponse,
                ),
                WebSocketRoute(
                    f&#34;/{servername}&#34;,
                    BroadcastWs
                )
            ],
        )

    def start(self):
        &#34;&#34;&#34;
        Start the server
        &#34;&#34;&#34;
        self.app.add_middleware(WSEventMiddleware, exit_round=self.exit_round)
        self.run(self.app, ws_max_size=self.ws_size)

    async def client_info(self, request: Request):
        server: Optional[Aggregator] = request.get(self.server_name)
        try:
            data = await request.json()
        except BaseException:
            data = {}
        client_id = data.get(&#34;client_id&#34;, &#34;&#34;) if data else &#34;&#34;
        if client_id:
            return server.get_client(client_id)
        return WSClientInfoList(clients=server.client_list)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="sedna.service.server.aggregation.AggregationServer"><code class="flex name class">
<span>class <span class="ident">AggregationServer</span></span>
<span>(</span><span>servername: str, host: str = None, http_port: int = 7363, exit_round: int = 1, ws_size: int = 10485760)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class AggregationServer(BaseServer):
    def __init__(
            self,
            servername: str,
            host: str = None,
            http_port: int = 7363,
            exit_round: int = 1,
            ws_size: int = 10 *
            1024 *
            1024):
        if not host:
            host = get_host_ip()
        super(
            AggregationServer,
            self).__init__(
            servername=servername,
            host=host,
            http_port=http_port,
            ws_size=ws_size)
        self.server_name = servername
        self.exit_round = max(int(exit_round), 1)
        self.app = FastAPI(
            routes=[
                APIRoute(
                    f&#34;/{servername}&#34;,
                    self.client_info,
                    response_class=JSONResponse,
                ),
                WebSocketRoute(
                    f&#34;/{servername}&#34;,
                    BroadcastWs
                )
            ],
        )

    def start(self):
        &#34;&#34;&#34;
        Start the server
        &#34;&#34;&#34;
        self.app.add_middleware(WSEventMiddleware, exit_round=self.exit_round)
        self.run(self.app, ws_max_size=self.ws_size)

    async def client_info(self, request: Request):
        server: Optional[Aggregator] = request.get(self.server_name)
        try:
            data = await request.json()
        except BaseException:
            data = {}
        client_id = data.get(&#34;client_id&#34;, &#34;&#34;) if data else &#34;&#34;
        if client_id:
            return server.get_client(client_id)
        return WSClientInfoList(clients=server.client_list)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="sedna.service.server.base.BaseServer" href="base.html#sedna.service.server.base.BaseServer">BaseServer</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="sedna.service.server.aggregation.AggregationServer.client_info"><code class="name flex">
<span>async def <span class="ident">client_info</span></span>(<span>self, request: starlette.requests.Request)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def client_info(self, request: Request):
    server: Optional[Aggregator] = request.get(self.server_name)
    try:
        data = await request.json()
    except BaseException:
        data = {}
    client_id = data.get(&#34;client_id&#34;, &#34;&#34;) if data else &#34;&#34;
    if client_id:
        return server.get_client(client_id)
    return WSClientInfoList(clients=server.client_list)</code></pre>
</details>
</dd>
<dt id="sedna.service.server.aggregation.AggregationServer.start"><code class="name flex">
<span>def <span class="ident">start</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Start the server</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def start(self):
    &#34;&#34;&#34;
    Start the server
    &#34;&#34;&#34;
    self.app.add_middleware(WSEventMiddleware, exit_round=self.exit_round)
    self.run(self.app, ws_max_size=self.ws_size)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="sedna.service.server" href="index.html">sedna.service.server</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="sedna.service.server.aggregation.AggregationServer" href="#sedna.service.server.aggregation.AggregationServer">AggregationServer</a></code></h4>
<ul class="">
<li><code><a title="sedna.service.server.aggregation.AggregationServer.client_info" href="#sedna.service.server.aggregation.AggregationServer.client_info">client_info</a></code></li>
<li><code><a title="sedna.service.server.aggregation.AggregationServer.start" href="#sedna.service.server.aggregation.AggregationServer.start">start</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>